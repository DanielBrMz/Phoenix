import Head from "next/head";
import { useEffect, useState, useCallback } from "react";
import mapboxgl from "mapbox-gl";
import "mapbox-gl/dist/mapbox-gl.css";
import addCustomLayers from "~/utils/mapUtils/addCustomLayers";
import addCustomSources from "~/utils/mapUtils/addCustomSources";
import Timeslider from "~/Components/TimeSlider";
import NavBar from "~/Components/NavBar";
import ServicesLayer from "~/Components/Layers/ServicesLayer";
import EmergencyAlerts from "~/Components/Alerts/EmergencyAlerts";
import Image from "next/image";
import PhoenixEyeLogo from "~/assets/phoenixeyelogo.png";
import StartPage from "./StartPage";
import { wildfiresStore } from "~/store/wildfiresStore";
import type { Alert } from "~/Components/Alerts/EmergencyAlerts";
import PopUp from "~/pages/MenuPages/PopUp";

const CENTER_COORDS: [number, number] = [-110.8968082457804, 31.25933620026809];
const MAPBOX_ACCESS_TOKEN =
  "pk.eyJ1IjoiaGVjdG9yZ3R6MjciLCJhIjoiY2xuZ3dmc215MDc2ZDJqbWFydmszaTVxZCJ9.VjBUl1K3sWQTxY5pce434A";
const INITIAL_ZOOM = 15;
const INITIAL_PITCH = 60;

export default function Home() {
  const [kilometersPerPixel, setKilometersPerPixel] = useState(0);
  const [map, setMap] = useState<mapboxgl.Map | null>(null);
  const [userLogin, setIsUserLogin] = useState(false);
  const [showPopUp, setShowPopUp] = useState(true);
  const selectedCoordinates = wildfiresStore(
    (state) => state.selectedCoordinates,
  );

  // Define the onAlertClick handler
  const onAlertClick = (alert: Alert) => {
    console.log("Alert clicked:", alert);
    // Add any additional logic you want to handle when an alert is clicked
  };

  // UseCallback to memoize the function
  const flyToLocation = useCallback(
    (coords: [number, number], zoom = 15) => {
      if (map) {
        map.flyTo({
          center: coords,
          zoom: zoom,
          speed: 0.8,
          curve: 1,
          easing(t) {
            return t;
          },
        });
      }
    },
    [map],
  );

  useEffect(() => {
    if (userLogin) {
      mapboxgl.accessToken = MAPBOX_ACCESS_TOKEN;

      const mapInstance = new mapboxgl.Map({
        container: "map",
        projection: { name: "globe" },
        style: "mapbox://styles/mapbox/satellite-streets-v12",
        center: CENTER_COORDS,
        zoom: INITIAL_ZOOM,
      });

      setMap(mapInstance);

      mapInstance.addControl(new mapboxgl.NavigationControl());
      mapInstance.addControl(new mapboxgl.FullscreenControl());

      mapInstance.on("style.load", () => {
        addCustomSources(mapInstance);
        addCustomLayers(mapInstance);

        mapInstance.setFog({
          color: "rgb(186, 210, 235)",
          "high-color": "rgb(36, 92, 223)",
          "horizon-blend": 0.02,
          "space-color": "rgb(11, 11, 25)",
          "star-intensity": 0.6,
        });

        mapInstance.setTerrain({ source: "mapbox-dem", exaggeration: 1.4 });
        mapInstance.setPitch(INITIAL_PITCH);

        mapInstance.on("zoom", () => {
          setKilometersPerPixel(
            (4007501.6686 *
              Math.abs(
                Math.cos((mapInstance.getCenter().lat * Math.PI) / 180),
              )) /
              Math.pow(2, mapInstance.getZoom() + 8),
          );
        });

        return () => {
          mapInstance.remove();
        };
      });
    }
  }, [userLogin]);

  useEffect(() => {
    if (selectedCoordinates && map) {
      flyToLocation(selectedCoordinates, 15);
    }
  }, [selectedCoordinates, map, flyToLocation]);

  const handleLogin = () => {
    setIsUserLogin(true);
    setShowPopUp(true);
  };

  return (
    <>
      <Head>
        <title>Phoenix Eye | Wildfire Prediction</title>
        <meta name="description" content="Generated by create-t3-app" />
        <link rel="icon" href={PhoenixEyeLogo.src} />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
      </Head>
      {!userLogin ? (
        <StartPage onLogin={handleLogin} />
      ) : (
        <main className="flex min-h-screen flex-col items-center justify-center bg-[#789]">
          <div id="map" style={{ width: "100%", height: "100vh" }}></div>
          <NavBar map={map} />
          {map && <Timeslider map={map} scale={kilometersPerPixel} />}
          {map && <ServicesLayer map={map} />}
          {map && <EmergencyAlerts map={map} onAlertClick={onAlertClick} />}
          <Image
            src={PhoenixEyeLogo}
            alt="Logo"
            width={100}
            height={100}
            className="z-1 absolute bottom-4 left-8"
          />
          {showPopUp && <PopUp onClose={() => setShowPopUp(false)} />}
        </main>
      )}
    </>
  );
}
